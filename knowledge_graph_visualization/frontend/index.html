<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çŸ¥è¯†å›¾è°±å¯è§†åŒ–ç³»ç»Ÿ</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #e0f7fa 0%, #e8f5e9 100%);
            color: #263238;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        .app-container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .panel {
            width: 300px;
            background: linear-gradient(180deg, #ffffff 0%, #f5f7fa 100%);
            padding: 15px;
            overflow-y: auto;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.05);
            border-radius: 8px;
            margin: 10px;
        }

        .visualization-panel {
            flex: 1;
            position: relative;
            margin: 10px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.85);
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.05);
        }

        #graph-container {
            width: 100%;
            height: 100%;
        }

        .controls {
            position: absolute;
            bottom: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
        }

        .control-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #4dd0e1 0%, #80deea 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            color: #263238;
        }

        .control-btn:hover {
            background: linear-gradient(135deg, #26c6da 0%, #4dd0e1 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-size: 14px;
            color: #546e7a;
        }

        input, select, textarea {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid #b2ebf2;
            border-radius: 4px;
            background: rgba(255, 255, 255, 0.8);
            color: #263238;
            font-size: 14px;
            transition: border 0.3s;
        }

        input:focus, select:focus, textarea:focus {
            border-color: #4dd0e1;
            outline: none;
            box-shadow: 0 0 0 2px rgba(77, 208, 225, 0.2);
        }

        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .btn-primary, .btn-secondary {
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #66bb6a 0%, #81c784 100%);
            color: #ffffff;
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(102, 187, 106, 0.3);
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #43a047 0%, #66bb6a 100%);
            box-shadow: 0 3px 6px rgba(102, 187, 106, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #b0bec5 0%, #cfd8dc 100%);
            color: #263238;
        }

        .btn-secondary:hover {
            background: linear-gradient(135deg, #90a4ae 0%, #b0bec5 100%);
        }

        .list-title {
            margin-bottom: 15px;
            padding-bottom: 5px;
            border-bottom: 1px solid #e0f2f1;
            color: #2e7d32;
        }

        .entity-item {
            background: linear-gradient(135deg, #f1f8e9 0%, #e8f5e9 100%);
            border-radius: 4px;
            padding: 10px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            border-left: 3px solid #81c784;
        }

        .entity-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.05);
        }

        .entity-info p {
            font-size: 12px;
            color: #607d8b;
            margin-top: 3px;
        }

        .entity-actions {
            display: flex;
            gap: 5px;
            margin-top: 5px;
        }

        .action-btn {
            font-size: 14px;
            cursor: pointer;
            opacity: 0.7;
            transition: opacity 0.2s;
        }

        .action-btn:hover {
            opacity: 1;
        }

        .edit-btn {
            color: #2e7d32;
        }

        .delete-btn {
            color: #e53935;
        }

        .no-data {
            color: #78909c;
            text-align: center;
            padding: 20px;
            font-style: italic;
        }

        .detail-header {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            padding-bottom: 5px;
            border-bottom: 1px solid #e0f2f1;
            color: #2e7d32;
        }

        .detail-section {
            margin-bottom: 15px;
        }

        .detail-section h3 {
            font-size: 14px;
            color: #546e7a;
            margin-bottom: 5px;
        }

        .detail-content {
            font-size: 15px;
            padding: 5px;
            background: #f1f8e9;
            border-radius: 4px;
            color: #263238;
        }

        /* å…³ç³»è¾¹æ ·å¼ - å¸¦ç®­å¤´ */
        .links line {
            stroke: #90a4ae;
            stroke-opacity: 0.6;
            transition: all 0.3s ease;
        }

        /* ç®­å¤´æ ‡è®°å®šä¹‰ */
        .arrowhead {
            fill: #90a4ae;
            stroke-opacity: 0.6;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        /* èŠ‚ç‚¹æ ·å¼ä¿®æ”¹ï¼šå¤§å®å¿ƒåœ† + å†…éƒ¨æ–‡å­— */
        .nodes circle {
            stroke: #ffffff;
            stroke-width: 2px;
            fill: #00BFFF;
            r: 35; /* å¢å¤§èŠ‚ç‚¹åŠå¾„ä¸º35px */
            transition: all 0.3s ease;
        }

        /* èŠ‚ç‚¹æ–‡å­—æ ·å¼ï¼šå±…ä¸­æ˜¾ç¤ºåœ¨åœ†å†… */
        .nodes text {
            fill: #ffffff; /* ç™½è‰²æ–‡å­—æ›´æ¸…æ™° */
            font-size: 8px;
            font-weight: 500;
            text-anchor: middle;
            dominant-baseline: middle; /* å‚ç›´å±…ä¸­ */
            pointer-events: none; /* æ–‡å­—ä¸é˜»ç¢ç‚¹å‡» */
            transition: all 0.3s ease;
        }

        /* å…³ç³»æ–‡å­—æ ·å¼ */
        .link-labels text {
            fill: #546e7a;
            font-size: 8px;
            text-anchor: middle;
            transition: all 0.3s ease;
        }

        /* å®ä½“ç‚¹å‡»é«˜äº® - é»„è‰²æ ·å¼ */
        .highlighted circle {
            stroke: #ffca28; /* é»„è‰²é«˜äº®è¾¹æ¡† */
            stroke-width: 3px;
            animation: pulse 1.5s infinite;
        }

        .highlighted text {
            fill: #f57f17; /* å®ä½“åç§°é«˜äº® */
            font-weight: bold;
        }

        /* æœç´¢ç»“æœé«˜äº® - é»„è‰²æ ·å¼ */
        .search-highlighted circle {
            stroke: #ffca28; /* é‡‘è‰²/é»„è‰² */
            stroke-width: 4px;
            animation: searchPulse 1.2s infinite;
            fill: #66bb6a;
        }

        .search-highlighted text {
            fill: #f57f17; /* å®ä½“åç§°é«˜äº® */
            font-weight: bold;
            font-size: 14px;
        }

        /* æœç´¢ç»“æœçš„å…³ç³»é«˜äº® */
        .search-highlighted-link {
            stroke: #ffca28 !important;
            stroke-width: 3px !important;
            stroke-opacity: 1 !important;
        }

        /* é«˜äº®çŠ¶æ€çš„ç®­å¤´ */
        .search-highlighted-arrow, .arrow-highlighted {
            fill: #ffca28 !important;
            stroke-opacity: 1 !important;
        }

        /* æœªæ¶‰åŠçš„å…ƒç´ é™ä½å¯è§æ€§ */
        .faded {
            opacity: 0.3;
        }

        /* å…³ç³»ç‚¹å‡»é«˜äº®æ ·å¼ */
        .link-highlighted {
            stroke: #ffca28 !important;
            stroke-width: 3px !important;
            stroke-opacity: 1 !important;
            animation: pulseLink 1.5s infinite;
        }

        .link-label-highlighted {
            fill: #f57f17 !important;
            font-weight: bold !important;
            font-size: 14px !important;
        }

        /* å…³ç³»å…³è”å®ä½“é«˜äº® */
        .relation-entity-highlighted circle {
            stroke: #ffca28 !important;
            stroke-width: 3px !important;
            animation: pulse 1.5s infinite;
        }

        .relation-entity-highlighted text {
            fill: #f57f17 !important;
            font-weight: bold !important;
        }

        @keyframes pulse {
            0% { stroke-width: 3px; }
            50% { stroke-width: 6px; }
            100% { stroke-width: 3px; }
        }

        @keyframes pulseLink {
            0% { stroke-width: 3px; }
            50% { stroke-width: 5px; }
            100% { stroke-width: 3px; }
        }

        @keyframes searchPulse {
            0% { stroke-width: 4px; stroke-opacity: 1; }
            50% { stroke-width: 6px; stroke-opacity: 0.8; }
            100% { stroke-width: 4px; stroke-opacity: 1; }
        }

        .search-container {
            display: flex;
            gap: 5px;
            margin-bottom: 20px;
            flex-direction: column;
        }

        .search-type-container {
            width: 100%;
            margin-bottom: 8px;
        }

        #search-type {
            width: 100%;
        }

        .search-input-group {
            display: flex;
            gap: 5px;
            width: 100%;
        }

        #search-input {
            flex: 1;
        }

        .search-results-info {
            color: #2e7d32;
            font-size: 12px;
            margin: -15px 0 15px 0;
            text-align: right;
            padding-right: 5px;
        }

        .file-operation-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 20px;
        }

        .file-input-container {
            position: relative;
            width: 100%;
        }

        #file-upload {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }

        /* å…³ç³»ç¼–è¾‘è¡¨å•æ ·å¼ */
        .relation-edit-form {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #e0f2f1;
        }

        .relation-item {
            margin-bottom: 10px;
            padding: 5px;
            background: #f1f8e9;
            border-radius: 4px;
        }

        /* å®ä½“å’Œå…³ç³»ç±»å‹é€‰æ‹©ä¸‹æ‹‰æ¡†æ ·å¼ */
        .entity-select-container, .relation-type-select-container {
            position: relative;
        }

        .entity-dropdown, .relation-type-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #b2ebf2;
            border-radius: 4px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 100;
            display: none;
            margin-top: 2px;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.05);
        }

        .entity-dropdown.visible, .relation-type-dropdown.visible {
            display: block;
        }

        .dropdown-item {
            padding: 8px 10px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .dropdown-item:hover {
            background-color: #e0f7fa;
        }

        .dropdown-item.active {
            background-color: #81c784;
            color: white;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="panel left-panel">
            <!-- æ–‡ä»¶æ“ä½œåŒºåŸŸ -->
            <div class="file-operation-group">
                <div class="file-input-container">
                    <button class="btn-secondary" style="width: 100%;">ä¸Šä¼ JSONæ–‡ä»¶</button>
                    <input type="file" id="file-upload" accept=".json">
                </div>

                <button id="save-current-data" class="btn-primary">ä¿å­˜æ–‡ä»¶</button>

                <div id="current-file-info" style="font-size: 12px; color: #546e7a; margin-top: -10px; margin-bottom: 10px; display: none;">
                    å½“å‰æ–‡ä»¶: <span id="current-file-name">-</span>
                </div>
            </div>

            <div class="form-section">
                <h3 id="entity-form-title" class="list-title">æ·»åŠ å®ä½“</h3>
                <div class="form-group">
                    <label for="entity-id">å®ä½“ID</label>
                    <input type="text" id="entity-id" placeholder="è¾“å…¥å”¯ä¸€ID">
                </div>
                <div class="form-group">
                    <label for="entity-name">å®ä½“åç§°</label>
                    <input type="text" id="entity-name" placeholder="è¾“å…¥å®ä½“åç§°">
                </div>
                <div class="form-group">
                    <label for="entity-desc">å®ä½“æè¿°</label>
                    <textarea id="entity-desc" rows="3" placeholder="è¾“å…¥å®ä½“æè¿°"></textarea>
                </div>
                <div class="btn-group">
                    <button id="add-entity" class="btn-primary">æ·»åŠ å®ä½“</button>
                    <button id="update-entity" class="btn-primary" style="display: none;">æ›´æ–°å®ä½“</button>
                    <button id="cancel-edit" class="btn-secondary" style="display: none;">å–æ¶ˆ</button>
                    <button id="clear-entity-form" class="btn-secondary">æ¸…ç©º</button>
                </div>
            </div>

            <div class="form-section" style="margin-top: 30px;">
                <h3 class="list-title">æ·»åŠ å…³ç³»</h3>
                <div class="form-group">
                    <label for="source-entity-display">æºå®ä½“</label>
                    <div class="entity-select-container">
                        <input type="text" id="source-entity-display" placeholder="é€‰æ‹©æˆ–æœç´¢æºå®ä½“">
                        <input type="hidden" id="source-entity" value="">
                        <div class="entity-dropdown" id="source-entity-dropdown"></div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="target-entity-display">ç›®æ ‡å®ä½“</label>
                    <div class="entity-select-container">
                        <input type="text" id="target-entity-display" placeholder="é€‰æ‹©æˆ–æœç´¢ç›®æ ‡å®ä½“">
                        <input type="hidden" id="target-entity" value="">
                        <div class="entity-dropdown" id="target-entity-dropdown"></div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="relation-type-display">å…³ç³»ç±»å‹</label>
                    <div class="relation-type-select-container">
                        <input type="text" id="relation-type-display" placeholder="è¾“å…¥æˆ–é€‰æ‹©å…³ç³»ç±»å‹">
                        <input type="hidden" id="relation-type" value="">
                        <div class="relation-type-dropdown" id="relation-type-dropdown"></div>
                    </div>
                </div>
                <div class="btn-group">
                    <button id="add-relation" class="btn-primary">æ·»åŠ å…³ç³»</button>
                    <button id="clear-relation-form" class="btn-secondary">æ¸…ç©º</button>
                </div>
            </div>

            <div class="entity-list">
                <h3 class="list-title">å®ä½“åˆ—è¡¨</h3>
                <div id="entities-container">
                    <div class="no-data">æš‚æ— å®ä½“æ•°æ®</div>
                </div>
            </div>
        </div>

        <div class="visualization-panel">
            <div id="graph-container"></div>
            <div class="controls">
                <div class="control-btn" id="zoom-in" title="æ”¾å¤§">+</div>
                <div class="control-btn" id="zoom-out" title="ç¼©å°">-</div>
                <div class="control-btn" id="fit-view" title="é€‚é…æ˜¾ç¤º">âŸ²</div>
                <div class="control-btn" id="reset-view" title="é‡ç½®å¸ƒå±€">âŸ³</div>
            </div>
        </div>

        <div class="panel right-panel">
            <div class="search-container">
                <!-- æœç´¢ç±»å‹é€‰æ‹©ä¸‹æ‹‰æ¡† -->
                <div class="search-type-container">
                    <select id="search-type">
                        <option value="entityId">å®ä½“ID</option>
                        <option value="entityName" selected>å®ä½“åç§°</option>
                        <option value="entityDesc">å®ä½“æè¿°</option>
                        <option value="relation">å…³ç³»ç±»å‹</option>
                    </select>
                </div>
                <div class="search-input-group">
                    <input type="text" id="search-input" placeholder="è¯·è¾“å…¥æœç´¢å†…å®¹...">
                    <button id="search-btn" class="btn-primary">æœç´¢</button>
                </div>
            </div>
            <div id="search-results-info" class="search-results-info"></div>
            <div id="detail-view">
                <div class="no-data">é€‰æ‹©ä¸€ä¸ªå®ä½“æˆ–å…³ç³»æŸ¥çœ‹è¯¦æƒ…</div>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let graphData = { nodes: [], links: [] };
        let svg = null;
        let simulation = null;
        let transform = d3.zoomIdentity;
        let zoom = null; // ç¼©æ”¾è¡Œä¸ºå¯¹è±¡
        let selectedNode = null;
        let selectedLink = null; // å½“å‰é€‰ä¸­çš„å…³ç³»
        let editingEntityId = null; // å½“å‰ç¼–è¾‘çš„å®ä½“ID
        let editingLinkIndex = -1; // å½“å‰ç¼–è¾‘çš„å…³ç³»ç´¢å¼•
        let searchResults = []; // å­˜å‚¨æœç´¢ç»“æœ
        let currentResultIndex = -1; // å½“å‰æ˜¾ç¤ºçš„ç»“æœç´¢å¼•
        let lastSearchKeyword = ''; // ä¸Šä¸€æ¬¡æœç´¢çš„å…³é”®å­—
        let lastSearchType = 'entityName'; // ä¸Šä¸€æ¬¡æœç´¢çš„ç±»å‹
        let linkElements = null; // å­˜å‚¨è¿çº¿å…ƒç´ å¼•ç”¨ï¼Œç”¨äºé«˜äº®
        let linkLabelElements = null; // å­˜å‚¨è¿çº¿æ ‡ç­¾å¼•ç”¨ï¼Œç”¨äºé«˜äº®
        let nodeGroups = null; // å­˜å‚¨èŠ‚ç‚¹ç»„å¼•ç”¨ï¼Œç”¨äºé«˜äº®
        let arrowElements = null; // å­˜å‚¨ç®­å¤´å…ƒç´ å¼•ç”¨
        let currentFilePath = null; // å½“å‰æ‰“å¼€çš„æ–‡ä»¶è·¯å¾„
        let usedRelationTypes = new Set(); // å·²ä½¿ç”¨çš„å…³ç³»ç±»å‹é›†åˆ

        // DOMå…ƒç´ 
        const entityIdInput = document.getElementById('entity-id');
        const entityNameInput = document.getElementById('entity-name');
        const entityDescInput = document.getElementById('entity-desc');
        const addEntityBtn = document.getElementById('add-entity');
        const updateEntityBtn = document.getElementById('update-entity');
        const cancelEditBtn = document.getElementById('cancel-edit');
        const clearEntityFormBtn = document.getElementById('clear-entity-form');
        const sourceEntityInput = document.getElementById('source-entity');
        const sourceEntityDisplay = document.getElementById('source-entity-display');
        const sourceEntityDropdown = document.getElementById('source-entity-dropdown');
        const targetEntityInput = document.getElementById('target-entity');
        const targetEntityDisplay = document.getElementById('target-entity-display');
        const targetEntityDropdown = document.getElementById('target-entity-dropdown');
        const relationTypeInput = document.getElementById('relation-type');
        const relationTypeDisplay = document.getElementById('relation-type-display');
        const relationTypeDropdown = document.getElementById('relation-type-dropdown');
        const addRelationBtn = document.getElementById('add-relation');
        const clearRelationFormBtn = document.getElementById('clear-relation-form');
        const entitiesContainer = document.getElementById('entities-container');
        const detailView = document.getElementById('detail-view');
        const searchInput = document.getElementById('search-input');
        const searchBtn = document.getElementById('search-btn');
        const searchTypeSelect = document.getElementById('search-type');
        const searchResultsInfo = document.getElementById('search-results-info');
        const zoomInBtn = document.getElementById('zoom-in');
        const zoomOutBtn = document.getElementById('zoom-out');
        const fitViewBtn = document.getElementById('fit-view');
        const resetViewBtn = document.getElementById('reset-view');
        const entityFormTitle = document.getElementById('entity-form-title');
        const fileUploadInput = document.getElementById('file-upload');
        const saveCurrentDataBtn = document.getElementById('save-current-data');
        const currentFileInfo = document.getElementById('current-file-info');
        const currentFileName = document.getElementById('current-file-name');

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        window.addEventListener('DOMContentLoaded', initialize);

        // åˆå§‹åŒ–å‡½æ•°
        async function initialize() {
            console.log('ç³»ç»Ÿåˆå§‹åŒ–å¼€å§‹');
            // åˆå§‹åŒ–é»˜è®¤æ•°æ®
            graphData = {
                nodes: [
                    { id: "1", name: "äººå·¥æ™ºèƒ½", description: "ç ”ç©¶å¦‚ä½•ä½¿æœºå™¨æ¨¡æ‹Ÿäººç±»æ™ºèƒ½çš„ç§‘å­¦" },
                    { id: "2", name: "æœºå™¨å­¦ä¹ ", description: "äººå·¥æ™ºèƒ½çš„ä¸€ä¸ªåˆ†æ”¯" },
                    { id: "3", name: "æ·±åº¦å­¦ä¹ ", description: "æœºå™¨å­¦ä¹ çš„ä¸€ä¸ªåˆ†æ”¯" },
                    { id: "4", name: "ç¥ç»ç½‘ç»œ", description: "å—äººè„‘ç»“æ„å¯å‘çš„è®¡ç®—æ¨¡å‹" },
                    { id: "5", name: "è®¡ç®—æœºè§†è§‰", description: "ä½¿è®¡ç®—æœºèƒ½å¤Ÿä»å›¾åƒä¸­è·å–ç†è§£çš„é¢†åŸŸ" },
                    { id: "6", name: "äººå·¥æ™ºèƒ½", description: "å¦ä¸€ä¸ªåä¸ºäººå·¥æ™ºèƒ½çš„å®ä½“ï¼ˆæµ‹è¯•ç”¨ï¼‰" },
                    { id: "7", name: "ç¥ç»ç½‘ç»œ", description: "å¦ä¸€ä¸ªç¥ç»ç½‘ç»œå®ä½“ï¼ˆæµ‹è¯•ç”¨ï¼‰" }
                ],
                links: [
                    { source: "1", target: "2", type: "åŒ…å«" },
                    { source: "2", target: "3", type: "åŒ…å«" },
                    { source: "3", target: "4", type: "åŸºäº" },
                    { source: "1", target: "5", type: "åŒ…å«" },
                    { source: "5", target: "3", type: "åº”ç”¨" },
                    { source: "6", target: "2", type: "åŒ…å«" },
                    { source: "6", target: "5", type: "åŒ…å«" },
                    { source: "3", target: "7", type: "åŸºäº" },
                    { source: "4", target: "7", type: "å…³è”" },
                    { source: "1", target: "6", type: "ç›¸ä¼¼" }
                ]
            };

            // åˆå§‹åŒ–å·²ä½¿ç”¨çš„å…³ç³»ç±»å‹é›†åˆ
            updateUsedRelationTypes();

            updateEntityDropdowns();
            updateRelationTypeDropdown();
            renderEntityList();
            initializeGraph();
            setupEventListeners();
            // åˆå§‹åŒ–å®ä½“è¡¨å•é»˜è®¤å€¼
            populateDefaultEntityValues();
            console.log('ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ');
        }

        // æ›´æ–°å·²ä½¿ç”¨çš„å…³ç³»ç±»å‹é›†åˆ
        function updateUsedRelationTypes() {
            usedRelationTypes.clear();
            graphData.links.forEach(link => {
                usedRelationTypes.add(link.type);
            });
        }

        // æ›´æ–°å…³ç³»ç±»å‹ä¸‹æ‹‰æ¡†
        function updateRelationTypeDropdown() {
            relationTypeDropdown.innerHTML = '';

            const relationTypes = Array.from(usedRelationTypes).sort();

            if (relationTypes.length === 0) {
                const emptyItem = document.createElement('div');
                emptyItem.className = 'dropdown-item';
                emptyItem.textContent = 'æš‚æ— å…³ç³»ç±»å‹';
                emptyItem.style.cursor = 'default';
                emptyItem.style.opacity = '0.7';
                relationTypeDropdown.appendChild(emptyItem);
                return;
            }

            relationTypes.forEach(type => {
                const item = document.createElement('div');
                item.className = 'dropdown-item';
                item.textContent = type;
                item.dataset.type = type;

                item.addEventListener('click', () => {
                    relationTypeInput.value = type;
                    relationTypeDisplay.value = type;
                    relationTypeDropdown.classList.remove('visible');
                });

                relationTypeDropdown.appendChild(item);
            });
        }

        // è¿‡æ»¤å…³ç³»ç±»å‹
        function filterRelationTypes(keyword) {
            if (!keyword) {
                return Array.from(usedRelationTypes).sort();
            }

            const lowerKeyword = keyword.toLowerCase();
            return Array.from(usedRelationTypes).filter(type =>
                type.toLowerCase().includes(lowerKeyword)
            );
        }

        // ------------------------------
        // æ–‡ä»¶ä¸Šä¼ ä¸ä¿å­˜åŠŸèƒ½
        // ------------------------------
        function setupFileEventListeners() {
            // ä¸Šä¼ JSONæ–‡ä»¶ - ä¿®å¤çš„å…³é”®éƒ¨åˆ†
            fileUploadInput.addEventListener('change', handleFileUpload);

            // ä¸ºä¸Šä¼ æŒ‰é’®æ·»åŠ ç‚¹å‡»äº‹ä»¶ï¼Œè§¦å‘æ–‡ä»¶é€‰æ‹©
            document.querySelector('.file-input-container .btn-secondary').addEventListener('click', () => {
                fileUploadInput.click();
            });

            // ä¿å­˜å½“å‰æ•°æ®åˆ°æœ¬åœ°
            saveCurrentDataBtn.addEventListener('click', saveCurrentData);
        }

        function handleFileUpload(event) {
            // ç¡®ä¿æœ‰æ–‡ä»¶è¢«é€‰æ‹©
            if (!event.target.files || event.target.files.length === 0) {
                console.log('æœªé€‰æ‹©æ–‡ä»¶');
                return;
            }

            const file = event.target.files[0];
            console.log('é€‰æ‹©çš„æ–‡ä»¶:', file);

            if (!file.name.endsWith('.json')) {
                alert('è¯·ä¸Šä¼ JSONæ ¼å¼çš„æ–‡ä»¶');
                fileUploadInput.value = '';
                return;
            }

            const reader = new FileReader();
            reader.onloadstart = () => {
                console.log('å¼€å§‹è¯»å–æ–‡ä»¶...');
            };

            reader.onload = function(e) {
                try {
                    console.log('æ–‡ä»¶è¯»å–å®Œæˆï¼Œå¼€å§‹è§£æ');
                    const importedData = JSON.parse(e.target.result);

                    if (!importedData.nodes || !importedData.links ||
                        !Array.isArray(importedData.nodes) || !Array.isArray(importedData.links)) {
                        throw new Error('JSONæ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®ï¼Œéœ€åŒ…å«nodeså’Œlinksæ•°ç»„');
                    }

                    const validNodes = importedData.nodes.every(node =>
                        node.id !== undefined && node.name !== undefined
                    );
                    if (!validNodes) {
                        throw new Error('èŠ‚ç‚¹æ•°æ®ä¸å®Œæ•´ï¼Œæ¯ä¸ªèŠ‚ç‚¹éœ€åŒ…å«idå’Œnameå­—æ®µ');
                    }

                    const validLinks = importedData.links.every(link =>
                        link.source !== undefined && link.target !== undefined && link.type !== undefined
                    );
                    if (!validLinks) {
                        throw new Error('å…³ç³»æ•°æ®ä¸å®Œæ•´ï¼Œæ¯ä¸ªå…³ç³»éœ€åŒ…å«sourceã€targetå’Œtypeå­—æ®µ');
                    }

                    graphData = importedData;
                    currentFilePath = file.name; // åªä½¿ç”¨æ–‡ä»¶åè€Œéå®Œæ•´è·¯å¾„ï¼Œé¿å…æµè§ˆå™¨å®‰å…¨é™åˆ¶
                    currentFileName.textContent = file.name;
                    currentFileInfo.style.display = 'block';

                    // æ›´æ–°å·²ä½¿ç”¨çš„å…³ç³»ç±»å‹
                    updateUsedRelationTypes();

                    updateEntityDropdowns();
                    updateRelationTypeDropdown();
                    renderEntityList();
                    reloadGraph();
                    detailView.innerHTML = '<div class="no-data">æ•°æ®å¯¼å…¥æˆåŠŸï¼Œè¯·é€‰æ‹©å®ä½“æˆ–å…³ç³»æŸ¥çœ‹è¯¦æƒ…</div>';
                    resetSearchState();
                    // æ›´æ–°å®ä½“è¡¨å•é»˜è®¤å€¼
                    populateDefaultEntityValues();
                    alert(`æ•°æ®å¯¼å…¥æˆåŠŸï¼å…±å¯¼å…¥ ${graphData.nodes.length} ä¸ªå®ä½“å’Œ ${graphData.links.length} ä¸ªå…³ç³»`);
                } catch (error) {
                    console.error('æ–‡ä»¶è§£æå¤±è´¥ï¼š', error);
                    alert(`å¯¼å…¥å¤±è´¥ï¼š${error.message}`);
                } finally {
                    // é‡ç½®æ–‡ä»¶è¾“å…¥ï¼Œå…è®¸é‡å¤é€‰æ‹©åŒä¸€æ–‡ä»¶
                    fileUploadInput.value = '';
                }
            };

            reader.onerror = function() {
                console.error('æ–‡ä»¶è¯»å–é”™è¯¯:', reader.error);
                alert(`æ–‡ä»¶è¯»å–å¤±è´¥: ${reader.error.message}`);
                fileUploadInput.value = '';
            };

            reader.readAsText(file);
        }

        function saveCurrentData() {
            try {
                // åˆ›å»ºè¾“å…¥æ¡†ç”¨äºè·å–æ–‡ä»¶è·¯å¾„
                const filePath = prompt('è¯·è¾“å…¥ä¿å­˜è·¯å¾„å’Œæ–‡ä»¶åï¼ˆåŒ…å«.jsonæ‰©å±•åï¼‰ï¼š',
                                      currentFilePath || `knowledge_graph_${new Date().toISOString().replace(/:/g, '-').split('.')[0]}.json`);

                if (!filePath) {
                    // ç”¨æˆ·å–æ¶ˆè¾“å…¥
                    return;
                }

                // ç¡®ä¿æ–‡ä»¶åä»¥.jsonç»“å°¾
                let fileName = filePath;
                if (!fileName.endsWith('.json')) {
                    fileName += '.json';
                }

                const cleanNodes = graphData.nodes.map(node => ({
                    id: node.id,
                    name: node.name,
                    ...(node.description && node.description.trim() ? { description: node.description } : {})
                }));

                const cleanLinks = graphData.links.map(link => {
                    const sourceId = typeof link.source === 'object' ? link.source.id : link.source;
                    const targetId = typeof link.target === 'object' ? link.target.id : link.target;

                    return {
                        source: sourceId,
                        target: targetId,
                        type: link.type
                    };
                });

                const exportData = {
                    nodes: cleanNodes,
                    links: cleanLinks
                };

                const dataStr = JSON.stringify(exportData, null, 2);
                const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);

                const link = document.createElement('a');
                link.href = dataUri;
                link.download = fileName;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                // æ›´æ–°å½“å‰æ–‡ä»¶ä¿¡æ¯
                currentFilePath = fileName;
                currentFileName.textContent = fileName.split(/[\\/]/).pop();
                currentFileInfo.style.display = 'block';

                console.log('å½“å‰æ•°æ®å·²ä¿å­˜åˆ°æ–‡ä»¶');
                alert(`æ•°æ®å·²æˆåŠŸä¿å­˜åˆ° ${fileName}`);
            } catch (error) {
                console.error('ä¿å­˜æ•°æ®å¤±è´¥ï¼š', error);
                alert(`ä¿å­˜å¤±è´¥ï¼š${error.message}`);
            }
        }

        // ------------------------------
        // å®ä½“ç®¡ç†ï¼ˆæ–°å¢/ä¿®æ”¹/åˆ é™¤ï¼‰
        // ------------------------------

        // ç”Ÿæˆé»˜è®¤çš„å®ä½“IDï¼ˆçŸ­æ•°å­—ï¼‰
        function generateDefaultEntityId() {
            // æŸ¥æ‰¾æœ€å¤§çš„æ•°å­—ID
            let maxId = 0;
            graphData.nodes.forEach(node => {
                const numId = parseInt(node.id, 10);
                if (!isNaN(numId) && numId > maxId) {
                    maxId = numId;
                }
            });
            // è¿”å›ä¸‹ä¸€ä¸ªæ•°å­—ID
            return (maxId + 1).toString();
        }

        // ç”Ÿæˆé»˜è®¤çš„å®ä½“åç§°
        function generateDefaultEntityName() {
            const baseNames = ['å®ä½“', 'æ¦‚å¿µ', 'å¯¹è±¡', 'å…ƒç´ ', 'èŠ‚ç‚¹'];
            const randomName = baseNames[Math.floor(Math.random() * baseNames.length)];
            return `${randomName}${graphData.nodes.length + 1}`;
        }

        // ç”Ÿæˆé»˜è®¤çš„å®ä½“æè¿°
        function generateDefaultEntityDescription() {
            const descriptions = [
                'è¿™æ˜¯ä¸€ä¸ªæ–°å®ä½“',
                'è¯¥å®ä½“çš„åŸºæœ¬æè¿°',
                'ç›¸å…³æ¦‚å¿µçš„è¯´æ˜',
                'æ–°åˆ›å»ºçš„å®ä½“ä¿¡æ¯',
                'å¾…å®Œå–„çš„å®ä½“æè¿°'
            ];
            return descriptions[Math.floor(Math.random() * descriptions.length)];
        }

        // å¡«å……å®ä½“è¡¨å•çš„é»˜è®¤å€¼
        function populateDefaultEntityValues() {
            if (editingEntityId === null) { // åªæœ‰åœ¨æ·»åŠ æ¨¡å¼ä¸‹æ‰å¡«å……é»˜è®¤å€¼
                entityIdInput.value = generateDefaultEntityId();
                entityNameInput.value = generateDefaultEntityName();
                entityDescInput.value = generateDefaultEntityDescription();
            }
        }

        function updateEntityDropdowns() {
            // æŒ‰æ·»åŠ æ—¶é—´æ’åºï¼Œæœ€è¿‘æ·»åŠ çš„åœ¨å‰é¢
            const sortedEntities = [...graphData.nodes].reverse();

            // æ›´æ–°æºå®ä½“ä¸‹æ‹‰æ¡†
            updateEntityDropdown(sourceEntityDropdown, sortedEntities);
            // æ›´æ–°ç›®æ ‡å®ä½“ä¸‹æ‹‰æ¡†
            updateEntityDropdown(targetEntityDropdown, sortedEntities);
        }

        function updateEntityDropdown(dropdownElement, entities) {
            dropdownElement.innerHTML = '';

            if (entities.length === 0) {
                const emptyItem = document.createElement('div');
                emptyItem.className = 'dropdown-item';
                emptyItem.textContent = 'æš‚æ— å®ä½“';
                emptyItem.style.cursor = 'default';
                emptyItem.style.opacity = '0.7';
                dropdownElement.appendChild(emptyItem);
                return;
            }

            entities.forEach(entity => {
                const item = document.createElement('div');
                item.className = 'dropdown-item';
                item.textContent = `${entity.name} (ID: ${entity.id})`;
                item.dataset.id = entity.id;
                item.dataset.name = entity.name;

                item.addEventListener('click', () => {
                    // æ ¹æ®ä¸‹æ‹‰æ¡†ç±»å‹æ›´æ–°å¯¹åº”è¾“å…¥æ¡†
                    if (dropdownElement.id === 'source-entity-dropdown') {
                        sourceEntityInput.value = entity.id;
                        sourceEntityDisplay.value = entity.name;
                        sourceEntityDropdown.classList.remove('visible');
                    } else if (dropdownElement.id === 'target-entity-dropdown') {
                        targetEntityInput.value = entity.id;
                        targetEntityDisplay.value = entity.name;
                        targetEntityDropdown.classList.remove('visible');
                    }
                });

                dropdownElement.appendChild(item);
            });
        }

        function filterEntities(keyword) {
            if (!keyword) {
                // å¦‚æœæ²¡æœ‰æœç´¢è¯ï¼Œè¿”å›æŒ‰æ·»åŠ æ—¶é—´æ’åºçš„å®ä½“
                return [...graphData.nodes].reverse();
            }

            const lowerKeyword = keyword.toLowerCase();
            return graphData.nodes.filter(entity =>
                entity.name.toLowerCase().includes(lowerKeyword) ||
                entity.id.toLowerCase().includes(lowerKeyword) ||
                (entity.description && entity.description.toLowerCase().includes(lowerKeyword))
            );
        }

        function renderEntityList() {
            if (graphData.nodes.length === 0) {
                entitiesContainer.innerHTML = '<div class="no-data">æš‚æ— å®ä½“æ•°æ®</div>';
                return;
            }

            entitiesContainer.innerHTML = '';
            graphData.nodes.forEach(node => {
                const entityItem = document.createElement('div');
                entityItem.className = 'entity-item';
                entityItem.innerHTML = `
                    <div class="entity-info">
                        <strong>${node.name}</strong>
                        <p>${node.description?.substring(0, 50) || ''}${node.description && node.description.length > 50 ? '...' : ''}</p>
                    </div>
                    <div class="entity-actions">
                        <div class="action-btn edit-btn" title="ç¼–è¾‘" data-id="${node.id}">âœï¸</div>
                        <div class="action-btn delete-btn" title="åˆ é™¤" data-id="${node.id}">ğŸ—‘ï¸</div>
                    </div>
                `;
                entityItem.querySelector('.edit-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    startEditEntity(node.id);
                });
                entityItem.querySelector('.delete-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    deleteEntity(node.id);
                });
                entityItem.addEventListener('click', () => {
                    showEntityDetail(node);
                    centerNodeInView(node.id);
                    resetSearchState();
                    // é«˜äº®é€‰ä¸­çš„å®ä½“
                    clearAllHighlights();
                    nodeGroups.filter(d => d.id === node.id).classed('highlighted', true);
                });
                entitiesContainer.appendChild(entityItem);
            });
        }

        function startEditEntity(id) {
            const entity = graphData.nodes.find(n => n.id === id);
            if (!entity) return;

            editingEntityId = id;
            entityFormTitle.textContent = 'ç¼–è¾‘å®ä½“';
            entityIdInput.value = entity.id;
            entityIdInput.disabled = true;
            entityNameInput.value = entity.name;
            entityDescInput.value = entity.description || '';

            addEntityBtn.style.display = 'none';
            updateEntityBtn.style.display = 'block';
            cancelEditBtn.style.display = 'block';
        }

        function cancelEdit() {
            editingEntityId = null;
            editingLinkIndex = -1;
            entityFormTitle.textContent = 'æ·»åŠ å®ä½“';
            entityIdInput.disabled = false;
            clearEntityForm();
            // é‡æ–°å¡«å……é»˜è®¤å€¼
            populateDefaultEntityValues();

            addEntityBtn.style.display = 'block';
            updateEntityBtn.style.display = 'none';
            cancelEditBtn.style.display = 'none';
        }

        function clearEntityForm() {
            entityIdInput.value = '';
            entityNameInput.value = '';
            entityDescInput.value = '';
        }

        function addEntity() {
            const id = entityIdInput.value.trim();
            const name = entityNameInput.value.trim();
            const description = entityDescInput.value.trim();

            if (!id || !name) {
                alert('å®ä½“IDå’Œåç§°ä¸èƒ½ä¸ºç©º');
                return;
            }

            if (graphData.nodes.some(node => node.id === id)) {
                alert('å®ä½“IDå·²å­˜åœ¨');
                // è‡ªåŠ¨ç”Ÿæˆæ–°çš„ID
                entityIdInput.value = generateDefaultEntityId();
                return;
            }

            const newEntity = { id, name };
            if (description) newEntity.description = description;
            graphData.nodes.push(newEntity);

            updateEntityDropdowns();
            renderEntityList();
            reloadGraph();
            // æ¸…ç©ºè¡¨å•å¹¶å¡«å……æ–°çš„é»˜è®¤å€¼
            clearEntityForm();
            populateDefaultEntityValues();
            alert('å®ä½“æ·»åŠ æˆåŠŸ');
        }

        function updateEntity() {
            if (!editingEntityId) return;

            const entity = graphData.nodes.find(n => n.id === editingEntityId);
            if (!entity) {
                alert('å®ä½“ä¸å­˜åœ¨');
                cancelEdit();
                return;
            }

            const name = entityNameInput.value.trim();
            const description = entityDescInput.value.trim();

            if (!name) {
                alert('å®ä½“åç§°ä¸èƒ½ä¸ºç©º');
                return;
            }

            entity.name = name;
            if (description) {
                entity.description = description;
            } else {
                delete entity.description;
            }

            renderEntityList();
            updateEntityDropdowns();
            reloadGraph();
            alert('å®ä½“æ›´æ–°æˆåŠŸ');

            if (selectedNode && selectedNode.id === editingEntityId) {
                showEntityDetail(entity);
            }

            cancelEdit();
        }

        function deleteEntity(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤æ­¤å®ä½“å—ï¼Ÿå…³è”çš„å…³ç³»ä¹Ÿå°†è¢«åˆ é™¤')) return;

            graphData.links = graphData.links.filter(link => {
                const sourceId = typeof link.source === 'object' ? link.source.id : link.source;
                const targetId = typeof link.target === 'object' ? link.target.id : link.target;
                return sourceId !== id && targetId !== id;
            });

            graphData.nodes = graphData.nodes.filter(node => node.id !== id);

            // æ›´æ–°å·²ä½¿ç”¨çš„å…³ç³»ç±»å‹
            updateUsedRelationTypes();
            updateRelationTypeDropdown();

            updateEntityDropdowns();
            renderEntityList();
            reloadGraph();

            // å¦‚æœåˆ é™¤çš„å®ä½“æ˜¯å½“å‰é€‰ä¸­çš„æºå®ä½“æˆ–ç›®æ ‡å®ä½“ï¼Œåˆ™æ¸…ç©º
            if (sourceEntityInput.value === id) {
                sourceEntityInput.value = '';
                sourceEntityDisplay.value = '';
            }
            if (targetEntityInput.value === id) {
                targetEntityInput.value = '';
                targetEntityDisplay.value = '';
            }

            if (selectedNode && selectedNode.id === id) {
                selectedNode = null;
                detailView.innerHTML = '<div class="no-data">é€‰æ‹©ä¸€ä¸ªå®ä½“æˆ–å…³ç³»æŸ¥çœ‹è¯¦æƒ…</div>';
            }

            resetSearchState();

            alert('å®ä½“åˆ é™¤æˆåŠŸ');
        }

        // ------------------------------
        // å…³ç³»ç®¡ç†ï¼ˆæ·»åŠ /ä¿®æ”¹/åˆ é™¤ï¼‰
        // ------------------------------
        function addRelation() {
            const sourceId = sourceEntityInput.value;
            const targetId = targetEntityInput.value;
            const type = relationTypeInput.value.trim();

            if (!sourceId || !targetId || !type) {
                alert('è¯·å®Œå–„å…³ç³»ä¿¡æ¯');
                return;
            }

            if (sourceId === targetId) {
                alert('æºå®ä½“å’Œç›®æ ‡å®ä½“ä¸èƒ½ç›¸åŒ');
                return;
            }

            const relationExists = graphData.links.some(link => {
                const linkSourceId = typeof link.source === 'object' ? link.source.id : link.source;
                const linkTargetId = typeof link.target === 'object' ? link.target.id : link.target;
                return linkSourceId === sourceId && linkTargetId === targetId && link.type === type;
            });

            if (relationExists) {
                alert('æ­¤å…³ç³»å·²å­˜åœ¨');
                return;
            }

            graphData.links.push({ source: sourceId, target: targetId, type });

            // æ›´æ–°å·²ä½¿ç”¨çš„å…³ç³»ç±»å‹
            updateUsedRelationTypes();
            updateRelationTypeDropdown();

            reloadGraph();
            clearRelationForm();

            if (selectedNode && (selectedNode.id === sourceId || selectedNode.id === targetId)) {
                showEntityDetail(selectedNode);
            }

            resetSearchState();

            alert('å…³ç³»æ·»åŠ æˆåŠŸ');
        }

        // å¼€å§‹ç¼–è¾‘å…³ç³»
        function startEditRelation(linkIndex) {
            if (linkIndex < 0 || linkIndex >= graphData.links.length) return;

            const link = graphData.links[linkIndex];
            editingLinkIndex = linkIndex;

            // è·å–æºå®ä½“å’Œç›®æ ‡å®ä½“çš„IDï¼ˆå¤„ç†å¯¹è±¡å¼•ç”¨çš„æƒ…å†µï¼‰
            const sourceId = typeof link.source === 'object' ? link.source.id : link.source;
            const targetId = typeof link.target === 'object' ? link.target.id : link.target;

            // å¡«å……è¡¨å•
            sourceEntityInput.value = sourceId;
            const sourceEntity = graphData.nodes.find(n => n.id === sourceId);
            sourceEntityDisplay.value = sourceEntity ? sourceEntity.name : '';

            targetEntityInput.value = targetId;
            const targetEntity = graphData.nodes.find(n => n.id === targetId);
            targetEntityDisplay.value = targetEntity ? targetEntity.name : '';

            relationTypeInput.value = link.type;
            relationTypeDisplay.value = link.type;

            // æ˜¾ç¤ºå…³ç³»è¯¦æƒ…è§†å›¾
            showRelationDetail(link);
        }

        // æ›´æ–°å…³ç³»
        function updateRelation() {
            if (editingLinkIndex < 0 || editingLinkIndex >= graphData.links.length) return;

            const originalLink = graphData.links[editingLinkIndex];
            const originalSourceId = typeof originalLink.source === 'object' ? originalLink.source.id : originalLink.source;
            const originalTargetId = typeof originalLink.target === 'object' ? originalLink.target.id : originalLink.target;

            const newSourceId = sourceEntityInput.value;
            const newTargetId = targetEntityInput.value;
            const newType = relationTypeInput.value.trim();

            if (!newSourceId || !newTargetId || !newType) {
                alert('è¯·å®Œå–„å…³ç³»ä¿¡æ¯');
                return;
            }

            if (newSourceId === newTargetId) {
                alert('æºå®ä½“å’Œç›®æ ‡å®ä½“ä¸èƒ½ç›¸åŒ');
                return;
            }

            // æ£€æŸ¥æ›´æ–°åçš„å…³ç³»æ˜¯å¦å·²å­˜åœ¨ï¼ˆæ’é™¤è‡ªèº«ï¼‰
            const relationExists = graphData.links.some((link, index) => {
                if (index === editingLinkIndex) return false; // è·³è¿‡è‡ªèº«

                const linkSourceId = typeof link.source === 'object' ? link.source.id : link.source;
                const linkTargetId = typeof link.target === 'object' ? link.target.id : link.target;
                return linkSourceId === newSourceId && linkTargetId === newTargetId && link.type === newType;
            });

            if (relationExists) {
                alert('æ­¤å…³ç³»å·²å­˜åœ¨');
                return;
            }

            // è®°å½•æ—§çš„å…³ç³»ç±»å‹ï¼Œç”¨äºæ›´æ–°å…³ç³»ç±»å‹é›†åˆ
            const oldType = originalLink.type;

            // æ›´æ–°å…³ç³»æ•°æ®
            graphData.links[editingLinkIndex] = {
                source: newSourceId,
                target: newTargetId,
                type: newType
            };

            // æ›´æ–°å·²ä½¿ç”¨çš„å…³ç³»ç±»å‹
            updateUsedRelationTypes();
            updateRelationTypeDropdown();

            // åˆ·æ–°ç•Œé¢
            reloadGraph();
            clearRelationForm();
            editingLinkIndex = -1;

            // æ›´æ–°è¯¦æƒ…è§†å›¾
            showRelationDetail(graphData.links[editingLinkIndex]);

            alert('å…³ç³»æ›´æ–°æˆåŠŸ');
        }

        function clearRelationForm() {
            sourceEntityInput.value = '';
            sourceEntityDisplay.value = '';
            targetEntityInput.value = '';
            targetEntityDisplay.value = '';
            relationTypeInput.value = '';
            relationTypeDisplay.value = '';
        }

        function deleteRelation(sourceId, targetId, type) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤å…³ç³»ã€Œ${type}ã€å—ï¼Ÿ`)) return;

            const initialLinkCount = graphData.links.length;
            const source = typeof sourceId === 'object' ? sourceId.id : sourceId;
            const target = typeof targetId === 'object' ? targetId.id : targetId;

            graphData.links = graphData.links.filter(link => {
                const linkSource = typeof link.source === 'object' ? link.source.id : link.source;
                const linkTarget = typeof link.target === 'object' ? link.target.id : link.target;
                return !(linkSource === source && linkTarget === target && link.type === type);
            });

            if (graphData.links.length < initialLinkCount) {
                // æ›´æ–°å·²ä½¿ç”¨çš„å…³ç³»ç±»å‹
                updateUsedRelationTypes();
                updateRelationTypeDropdown();

                reloadGraph();

                if (selectedNode && (selectedNode.id === source || selectedNode.id === target)) {
                    showEntityDetail(selectedNode);
                }

                if (selectedLink &&
                    (typeof selectedLink.source === 'object' ? selectedLink.source.id : selectedLink.source) === source &&
                    (typeof selectedLink.target === 'object' ? selectedLink.target.id : selectedLink.target) === target &&
                    selectedLink.type === type) {
                    selectedLink = null;
                    detailView.innerHTML = '<div class="no-data">é€‰æ‹©ä¸€ä¸ªå®ä½“æˆ–å…³ç³»æŸ¥çœ‹è¯¦æƒ…</div>';
                }

                resetSearchState();

                alert('å…³ç³»åˆ é™¤æˆåŠŸ');
            } else {
                alert('æœªæ‰¾åˆ°è¯¥å…³ç³»æˆ–åˆ é™¤å¤±è´¥');
            }
        }

        // ------------------------------
        // å›¾è°±å¯è§†åŒ–ä¸äº¤äº’
        // ------------------------------
        function initializeGraph() {
            const container = document.getElementById('graph-container');
            const width = container.clientWidth;
            const height = container.clientHeight;

            d3.select('#graph-container').select('svg').remove();

            svg = d3.select('#graph-container')
                .append('svg')
                .attr('width', '100%')
                .attr('height', '100%')
                .attr('viewBox', [0, 0, width, height])
                .on('click', handleSvgClick); // æ·»åŠ ç©ºç™½å¤„ç‚¹å‡»äº‹ä»¶

            // å®šä¹‰ç®­å¤´æ ‡è®°ï¼Œä¸ºæ¯ä¸ªç®­å¤´æ·»åŠ å”¯ä¸€ID
            const defs = svg.append('defs');
            graphData.links.forEach((link, index) => {
                defs.append('marker')
                    .attr('id', `arrow-${index}`)
                    .attr('viewBox', '0 -5 10 10')
                    .attr('refX', 45) // ç®­å¤´ä½ç½®è°ƒæ•´ï¼Œé€‚åº”å¤§èŠ‚ç‚¹
                    .attr('refY', 0)
                    .attr('markerWidth', 6)
                    .attr('markerHeight', 6)
                    .attr('orient', 'auto')
                    .append('path')
                    .attr('d', 'M0,-5L10,0L0,5')
                    .attr('class', 'arrowhead')
                    .attr('data-link-index', index)
                    .on('click', function(event) {
                        event.stopPropagation();
                        const linkIndex = parseInt(d3.select(this).attr('data-link-index'));
                        const link = graphData.links[linkIndex];
                        if (link) {
                            selectedLink = link;
                            clearAllHighlights();
                            highlightRelationAndEntities(link);
                            showRelationDetail(link);
                            centerRelationInView(link);
                            resetSearchState();
                        }
                    });
            });

            zoom = d3.zoom()
                .scaleExtent([0.1, 5])
                .on('zoom', (event) => {
                    transform = event.transform;
                    g.attr('transform', transform);
                });

            svg.call(zoom);

            const g = svg.append('g');

            // è°ƒæ•´åŠ›å¯¼å‘å‚æ•°ï¼Œé€‚åº”å¤§èŠ‚ç‚¹
            simulation = d3.forceSimulation(graphData.nodes)
                .force('link', d3.forceLink(graphData.links).id(d => d.id).distance(200)) // å¢åŠ èŠ‚ç‚¹é—´è·
                .force('charge', d3.forceManyBody().strength(-600)) // å¢åŠ æ’æ–¥åŠ›
                .force('center', d3.forceCenter(width / 2, height / 2))
                .force('collision', d3.forceCollide().radius(70)); // å¢åŠ ç¢°æ’æ£€æµ‹åŠå¾„

            // ç»˜åˆ¶è¿çº¿å¹¶æ·»åŠ ç®­å¤´ï¼Œä¸ºæ¯æ¡çº¿åˆ†é…å¯¹åº”çš„ç®­å¤´ID
            linkElements = g.append('g')
                .attr('class', 'links')
                .selectAll('line')
                .data(graphData.links)
                .enter()
                .append('line')
                .attr('class', 'link')
                .attr('stroke-width', 2)
                .attr('data-link-index', (d, i) => i)
                .attr('marker-end', (d, i) => `url(#arrow-${i})`) // ä¸ºæ¯æ¡çº¿åˆ†é…å¯¹åº”çš„ç®­å¤´
                .on('click', (event, d) => {
                    // ç‚¹å‡»å…³ç³»è¾¹æ˜¾ç¤ºè¯¦æƒ…
                    event.stopPropagation();
                    selectedLink = d;
                    clearAllHighlights();

                    // é«˜äº®å½“å‰å…³ç³»åŠç›¸å…³å®ä½“å’Œç®­å¤´
                    highlightRelationAndEntities(d);

                    showRelationDetail(d);
                    centerRelationInView(d);
                    resetSearchState();
                });

            // ç»˜åˆ¶è¿çº¿æ ‡ç­¾
            linkLabelElements = g.append('g')
                .attr('class', 'link-labels')
                .selectAll('text')
                .data(graphData.links)
                .enter()
                .append('text')
                .attr('class', 'link-label')
                .attr('data-link-index', (d, i) => i)
                .text(d => d.type)
                .on('click', (event, d) => {
                    // ç‚¹å‡»å…³ç³»æ ‡ç­¾æ˜¾ç¤ºè¯¦æƒ…
                    event.stopPropagation();
                    selectedLink = d;
                    clearAllHighlights();

                    // é«˜äº®å½“å‰å…³ç³»åŠç›¸å…³å®ä½“å’Œç®­å¤´
                    highlightRelationAndEntities(d);

                    showRelationDetail(d);
                    centerRelationInView(d);
                    resetSearchState();
                });

            // ç»˜åˆ¶èŠ‚ç‚¹
            nodeGroups = g.append('g')
                .attr('class', 'nodes')
                .selectAll('g')
                .data(graphData.nodes)
                .enter()
                .append('g')
                .attr('data-id', d => d.id)
                .call(d3.drag()
                    .on('start', dragstarted)
                    .on('drag', dragged)
                    .on('end', dragended));

            // å¤§å®å¿ƒåœ†èŠ‚ç‚¹
            nodeGroups.append('circle')
                .attr('r', 25) // å¤§èŠ‚ç‚¹åŠå¾„
                .attr('fill', '#66bb6a');

            // èŠ‚ç‚¹å†…éƒ¨æ–‡å­—ï¼ˆå±…ä¸­æ˜¾ç¤ºï¼‰
            nodeGroups.append('text')
                .attr('text-anchor', 'middle')
                .attr('dominant-baseline', 'middle')
                .text(d => {
                    // é•¿åç§°è‡ªåŠ¨æˆªæ–­æ˜¾ç¤º
                    if (d.name.length > 5) {
                        return d.name.substring(0, 5) + '...';
                    }
                    return d.name;
                })
                .attr('fill', '#ffffff'); // ç™½è‰²æ–‡å­—ï¼Œä¸èŠ‚ç‚¹å½¢æˆå¯¹æ¯”

            nodeGroups.on('click', (event, d) => {
                event.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡åˆ°SVG
                selectedNode = d;
                selectedLink = null;
                clearAllHighlights();
                d3.select(event.currentTarget).classed('highlighted', true);
                showEntityDetail(d);
                centerNodeInView(d.id);
                resetSearchState();
            });

            // å­˜å‚¨ç®­å¤´å…ƒç´ å¼•ç”¨ï¼Œæ·»åŠ æ•°æ®å±æ€§æ ‡è¯†å¯¹åº”çš„å…³ç³»ç´¢å¼•
            arrowElements = svg.selectAll('.arrowhead');

            simulation.on('tick', () => {
                linkElements
                    .attr('x1', d => d.source.x)
                    .attr('y1', d => d.source.y)
                    .attr('x2', d => d.target.x)
                    .attr('y2', d => d.target.y);

                linkLabelElements
                    .attr('x', d => (d.source.x + d.target.x) / 2)
                    .attr('y', d => (d.source.y + d.target.y) / 2);

                nodeGroups.attr('transform', d => `translate(${d.x},${d.y})`);
            });

            console.log('å›¾è°±åˆå§‹åŒ–å®Œæˆï¼ŒèŠ‚ç‚¹æ•°ï¼š', graphData.nodes.length);
        }

        // é«˜äº®å…³ç³»åŠç›¸å…³å®ä½“å’Œç®­å¤´
        function highlightRelationAndEntities(link) {
            // æ‰¾åˆ°å½“å‰å…³ç³»åœ¨æ•°ç»„ä¸­çš„ç´¢å¼•
            const linkIndex = graphData.links.indexOf(link);
            if (linkIndex === -1) return;

            // è·å–æºå®ä½“å’Œç›®æ ‡å®ä½“çš„ID
            const sourceId = typeof link.source === 'object' ? link.source.id : link.source;
            const targetId = typeof link.target === 'object' ? link.target.id : link.target;

            // é«˜äº®å…³ç³»çº¿
            linkElements.filter((l, i) => i === linkIndex).classed('link-highlighted', true);

            // é«˜äº®ç®­å¤´ - ä¿®å¤çš„å…³é”®éƒ¨åˆ†
            d3.select(`#arrow-${linkIndex}`).select('path').classed('arrow-highlighted', true);

            // é«˜äº®å…³ç³»æ ‡ç­¾
            linkLabelElements.filter((l, i) => i === linkIndex).classed('link-label-highlighted', true);

            // é«˜äº®æºå®ä½“å’Œç›®æ ‡å®ä½“
            nodeGroups.filter(d => d.id === sourceId || d.id === targetId)
                .classed('relation-entity-highlighted', true);
        }

        // å¤„ç†SVGç©ºç™½å¤„ç‚¹å‡»äº‹ä»¶
        function handleSvgClick(event) {
            // åªæœ‰ç‚¹å‡»ç©ºç™½å¤„æ‰è§¦å‘
            if (event.target === svg.node()) {
                clearAllHighlights();
                selectedNode = null;
                selectedLink = null;
                detailView.innerHTML = '<div class="no-data">é€‰æ‹©ä¸€ä¸ªå®ä½“æˆ–å…³ç³»æŸ¥çœ‹è¯¦æƒ…</div>';
                resetSearchState();
            }
        }

        // æ¸…é™¤æ‰€æœ‰é«˜äº®æ•ˆæœ
        function clearAllHighlights() {
            if (!svg) return;
            // æ¸…é™¤èŠ‚ç‚¹é«˜äº®å’Œæ·¡åŒ–æ•ˆæœ
            if (nodeGroups) {
                nodeGroups
                    .classed('highlighted', false)
                    .classed('search-highlighted', false)
                    .classed('relation-entity-highlighted', false)
                    .classed('faded', false);
            }
            // æ¸…é™¤è¿çº¿é«˜äº®å’Œæ·¡åŒ–æ•ˆæœ
            if (linkElements) {
                linkElements
                    .classed('search-highlighted-link', false)
                    .classed('link-highlighted', false)
                    .classed('faded', false);
            }
            // æ¸…é™¤è¿çº¿æ ‡ç­¾é«˜äº®å’Œæ·¡åŒ–æ•ˆæœ
            if (linkLabelElements) {
                linkLabelElements
                    .classed('search-highlighted-link-label', false)
                    .classed('link-label-highlighted', false)
                    .classed('faded', false);
            }
            // æ¸…é™¤ç®­å¤´é«˜äº®å’Œæ·¡åŒ–æ•ˆæœ
            if (arrowElements) {
                arrowElements
                    .classed('search-highlighted-arrow', false)
                    .classed('arrow-highlighted', false)
                    .classed('faded', false);
            }
        }

        // èŠ‚ç‚¹æ‹–æ‹½äº¤äº’å‡½æ•°
        function dragstarted(event, d) {
            if (!event.active) simulation.alphaTarget(0.3).restart();
            d.fx = d.x;
            d.fy = d.y;
        }

        function dragged(event, d) {
            d.fx = event.x;
            d.fy = event.y;
        }

        function dragended(event, d) {
            if (!event.active) simulation.alphaTarget(0);
            d.fx = null;
            d.fy = null;
        }

        function reloadGraph() {
            console.log('é‡æ–°åŠ è½½å›¾è°±ï¼ŒèŠ‚ç‚¹æ•°ï¼š', graphData.nodes.length);
            graphData.links.forEach(link => {
                if (typeof link.source !== 'string') link.source = link.source.id;
                if (typeof link.target !== 'string') link.target = link.target.id;
            });
            initializeGraph();
        }

        // è§†å›¾æ§åˆ¶åŠŸèƒ½
        function zoomIn() {
            if (!svg || !zoom) return;
            svg.transition().duration(300).call(
                zoom.scaleBy, 1.3
            );
        }

        function zoomOut() {
            if (!svg || !zoom) return;
            svg.transition().duration(300).call(
                zoom.scaleBy, 0.77
            );
        }

        function fitView() {
            if (!svg || !zoom || graphData.nodes.length === 0) return;

            const nodes = graphData.nodes;
            const minX = Math.min(...nodes.map(d => d.x));
            const maxX = Math.max(...nodes.map(d => d.x));
            const minY = Math.min(...nodes.map(d => d.y));
            const maxY = Math.max(...nodes.map(d => d.y));

            const width = maxX - minX;
            const height = maxY - minY;

            const container = document.getElementById('graph-container');
            const containerWidth = container.clientWidth;
            const containerHeight = container.clientHeight;

            const scaleX = containerWidth / (width * 1.1);
            const scaleY = containerHeight / (height * 1.1);
            const scale = Math.min(scaleX, scaleY, 1);

            const centerX = (minX + maxX) / 2;
            const centerY = (minY + maxY) / 2;

            svg.transition().duration(700).call(
                zoom.transform,
                d3.zoomIdentity
                    .translate(containerWidth / 2, containerHeight / 2)
                    .scale(scale)
                    .translate(-centerX, -centerY)
            );
        }

        function resetLayout() {
            if (!simulation) return;

            simulation.alpha(0.3).restart();

            if (svg && zoom) {
                svg.transition().duration(300).call(
                    zoom.transform,
                    transform
                );
            }
        }

        function centerNodeInView(nodeId) {
            if (!svg || !zoom) return;

            const node = graphData.nodes.find(n => n.id === nodeId);
            if (!node) return;

            const container = document.getElementById('graph-container');
            const containerWidth = container.clientWidth;
            const containerHeight = container.clientHeight;

            // å‡å°ç¼©æ”¾æ¯”ä¾‹ï¼Œä½¿å±…ä¸­æ”¾å¤§æ•ˆæœæ›´å°
            let scale = 1.0;
            if (graphData.nodes.length > 10) {
                scale = 1.3;
            } else if (graphData.nodes.length <= 3) {
                scale = 0.8;
            }

            scale = Math.min(scale, 3); // é™åˆ¶æœ€å¤§ç¼©æ”¾æ¯”ä¾‹

            svg.transition()
                .duration(800)
                .ease(d3.easeCubic)
                .call(zoom.transform,
                    d3.zoomIdentity
                        .translate(containerWidth / 2, containerHeight / 2)
                        .scale(scale)
                        .translate(-node.x, -node.y)
                );
        }

        // ä¸ºæœç´¢åˆ°çš„å®ä½“æ·»åŠ é»„è‰²é«˜äº®ï¼Œå¹¶æ·¡åŒ–å…¶ä»–å®ä½“å’Œå…³ç³»
        function highlightSearchEntity(nodeId) {
            clearAllHighlights();

            // é«˜äº®åŒ¹é…çš„å®ä½“
            nodeGroups.filter(d => d.id === nodeId)
                .classed('search-highlighted', true);

            // æ·¡åŒ–æ‰€æœ‰å…¶ä»–å®ä½“
            nodeGroups.filter(d => d.id !== nodeId)
                .classed('faded', true);

            // æ·¡åŒ–æ‰€æœ‰å…³ç³»
            if (linkElements) {
                linkElements.classed('faded', true);
            }
            if (linkLabelElements) {
                linkLabelElements.classed('faded', true);
            }
            if (arrowElements) {
                arrowElements.classed('faded', true);
            }
        }

        // ä¸ºæœç´¢åˆ°çš„å…³ç³»æ·»åŠ é»„è‰²é«˜äº®ï¼Œå¹¶æ·¡åŒ–å…¶ä»–å®ä½“å’Œå…³ç³»
        function highlightSearchRelation(link) {
            clearAllHighlights();

            // æ‰¾åˆ°å½“å‰å…³ç³»åœ¨æ•°ç»„ä¸­çš„ç´¢å¼•
            const linkIndex = graphData.links.findIndex(l => {
                const lSourceId = typeof l.source === 'object' ? l.source.id : l.source;
                const lTargetId = typeof l.target === 'object' ? l.target.id : l.target;
                const sourceId = typeof link.source === 'object' ? link.source.id : link.source;
                const targetId = typeof link.target === 'object' ? link.target.id : link.target;
                return lSourceId === sourceId && lTargetId === targetId && l.type === link.type;
            });

            if (linkIndex === -1) return; // æœªæ‰¾åˆ°å…³ç³»ï¼Œé€€å‡º

            const sourceId = typeof link.source === 'object' ? link.source.id : link.source;
            const targetId = typeof link.target === 'object' ? link.target.id : link.target;
            const relationType = link.type;

            // é«˜äº®ç›¸å…³èŠ‚ç‚¹
            nodeGroups.filter(d => d.id === sourceId || d.id === targetId)
                .classed('search-highlighted', true);

            // æ·¡åŒ–å…¶ä»–èŠ‚ç‚¹
            nodeGroups.filter(d => d.id !== sourceId && d.id !== targetId)
                .classed('faded', true);

            // é«˜äº®åŒ¹é…çš„å…³ç³»è¿çº¿
            if (linkElements) {
                linkElements.filter(l => {
                    const lSourceId = typeof l.source === 'object' ? l.source.id : l.source;
                    const lTargetId = typeof l.target === 'object' ? l.target.id : l.target;
                    return lSourceId === sourceId && lTargetId === targetId && l.type === relationType;
                }).classed('search-highlighted-link', true)
                  .classed('faded', false);

                // æ·¡åŒ–å…¶ä»–å…³ç³»
                linkElements.filter(l => {
                    const lSourceId = typeof l.source === 'object' ? l.source.id : l.source;
                    const lTargetId = typeof l.target === 'object' ? l.target.id : l.target;
                    return !(lSourceId === sourceId && lTargetId === targetId && l.type === relationType);
                }).classed('faded', true);
            }

            // é«˜äº®åŒ¹é…çš„å…³ç³»æ ‡ç­¾
            if (linkLabelElements) {
                linkLabelElements.filter(l => {
                    const lSourceId = typeof l.source === 'object' ? l.source.id : l.source;
                    const lTargetId = typeof l.target === 'object' ? l.target.id : l.target;
                    return lSourceId === sourceId && lTargetId === targetId && l.type === relationType;
                }).classed('search-highlighted-link-label', true)
                  .classed('faded', false);

                // æ·¡åŒ–å…¶ä»–å…³ç³»æ ‡ç­¾
                linkLabelElements.filter(l => {
                    const lSourceId = typeof l.source === 'object' ? l.source.id : l.source;
                    const lTargetId = typeof l.target === 'object' ? l.target.id : l.target;
                    return !(lSourceId === sourceId && lTargetId === targetId && l.type === relationType);
                }).classed('faded', true);
            }

            // é«˜äº®åŒ¹é…å…³ç³»çš„ç®­å¤´
            if (arrowElements) {
                // æ‰¾åˆ°å½“å‰å…³ç³»å¯¹åº”çš„ç®­å¤´å¹¶é«˜äº®
                arrowElements.filter(`[data-link-index="${linkIndex}"]`)
                    .classed('search-highlighted-arrow', true)
                    .classed('faded', false);

                // æ·¡åŒ–å…¶ä»–ç®­å¤´
                arrowElements.filter(`[data-link-index!="${linkIndex}"]`)
                    .classed('faded', true);
            }
        }

        function centerRelationInView(link) {
            if (!svg || !zoom || !link) return;

            const sourceId = typeof link.source === 'object' ? link.source.id : link.source;
            const targetId = typeof link.target === 'object' ? link.target.id : link.target;

            const sourceNode = graphData.nodes.find(n => n.id === sourceId);
            const targetNode = graphData.nodes.find(n => n.id === targetId);
            if (!sourceNode || !targetNode) return;

            // è®¡ç®—å…³ç³»ä¸­ç‚¹
            const midX = (sourceNode.x + targetNode.x) / 2;
            const midY = (sourceNode.y + targetNode.y) / 2;

            // è®¡ç®—ä¸¤ç‚¹ä¹‹é—´çš„è·ç¦»ï¼Œç”¨äºåŠ¨æ€è°ƒæ•´ç¼©æ”¾çº§åˆ«
            const distance = Math.sqrt(
                Math.pow(sourceNode.x - targetNode.x, 2) +
                Math.pow(sourceNode.y - targetNode.y, 2)
            );

            const container = document.getElementById('graph-container');
            const containerWidth = container.clientWidth;
            const containerHeight = container.clientHeight;

            // å‡å°ç¼©æ”¾æ¯”ä¾‹ï¼Œä½¿å±…ä¸­æ”¾å¤§æ•ˆæœæ›´å°
            let scale = Math.min(containerWidth / (distance * 2.0), 2);
            scale = Math.max(scale, 0.5); // ç¡®ä¿ç¼©æ”¾ä¸ä¼šå¤ªå°

            svg.transition()
                .duration(800)
                .ease(d3.easeCubic)
                .call(zoom.transform,
                    d3.zoomIdentity
                        .translate(containerWidth / 2, containerHeight / 2)
                        .scale(scale)
                        .translate(-midX, -midY)
                );
        }

        // ------------------------------
        // è¯¦æƒ…å±•ç¤ºä¸ç¼–è¾‘åŠŸèƒ½
        // ------------------------------
        function showEntityDetail(entity) {
            selectedNode = entity;
            selectedLink = null;

            const relatedLinks = graphData.links.filter(link => {
                const sourceId = typeof link.source === 'object' ? link.source.id : link.source;
                const targetId = typeof link.target === 'object' ? link.target.id : link.target;
                return sourceId === entity.id || targetId === entity.id;
            });

            let relationsHtml = '';
            relatedLinks.forEach((link, index) => {
                const isSource = (typeof link.source === 'object' ? link.source.id : link.source) === entity.id;
                const otherNodeId = isSource
                    ? (typeof link.target === 'object' ? link.target.id : link.target)
                    : (typeof link.source === 'object' ? link.source.id : link.source);
                const otherNode = graphData.nodes.find(n => n.id === otherNodeId);

                const sourceId = isSource ? entity.id : otherNodeId;
                const targetId = isSource ? otherNodeId : entity.id;
                const linkIndex = graphData.links.findIndex(l => {
                    const lSourceId = typeof l.source === 'object' ? l.source.id : l.source;
                    const lTargetId = typeof l.target === 'object' ? l.target.id : l.target;
                    return lSourceId === sourceId && lTargetId === targetId && l.type === link.type;
                });

                relationsHtml += `
                    <div class="relation-item">
                        <strong>${isSource ? 'â†’ ' : 'â† '}${link.type}</strong>
                        <div>${otherNode ? otherNode.name : 'æœªçŸ¥å®ä½“'}</div>
                        <div class="entity-actions" style="margin-top: 5px;">
                            <div class="action-btn edit-btn"
                                onclick="startEditRelation(${linkIndex})">
                                ç¼–è¾‘
                            </div>
                            <div class="action-btn delete-btn"
                                onclick="deleteRelation('${sourceId}', '${targetId}', '${link.type}')">
                                åˆ é™¤
                            </div>
                        </div>
                    </div>
                `;
            });

            detailView.innerHTML = `
                <div class="detail-header">å®ä½“è¯¦æƒ…</div>
                <div class="detail-section">
                    <h3>å®ä½“ID</h3>
                    <div class="detail-content">${entity.id}</div>
                </div>
                <div class="detail-section">
                    <h3>å®ä½“åç§°</h3>
                    <div class="detail-content">${entity.name}</div>
                </div>
                <div class="detail-section">
                    <h3>å®ä½“æè¿°</h3>
                    <div class="detail-content">${entity.description || 'æ— æè¿°'}</div>
                </div>
                <div class="detail-section">
                    <h3>æ“ä½œ</h3>
                    <div class="entity-actions">
                        <div class="action-btn edit-btn" onclick="startEditEntity('${entity.id}')">
                            ç¼–è¾‘å®ä½“
                        </div>
                        <div class="action-btn delete-btn" onclick="deleteEntity('${entity.id}')">
                            åˆ é™¤å®ä½“
                        </div>
                    </div>
                </div>
                <div class="detail-section">
                    <h3>å…³è”å…³ç³» (${relatedLinks.length})</h3>
                    <div class="detail-content">
                        ${relationsHtml || 'æ— å…³è”å…³ç³»'}
                    </div>
                </div>
            `;
        }

        // æ˜¾ç¤ºå…³ç³»è¯¦æƒ…å¹¶æä¾›ç¼–è¾‘åŠŸèƒ½
        function showRelationDetail(link) {
            selectedLink = link;
            selectedNode = null;

            const sourceId = typeof link.source === 'object' ? link.source.id : link.source;
            const targetId = typeof link.target === 'object' ? link.target.id : link.target;
            const sourceEntity = graphData.nodes.find(n => n.id === sourceId);
            const targetEntity = graphData.nodes.find(n => n.id === targetId);

            // æ‰¾åˆ°å…³ç³»åœ¨æ•°ç»„ä¸­çš„ç´¢å¼•
            const linkIndex = graphData.links.findIndex(l => {
                const lSourceId = typeof l.source === 'object' ? l.source.id : l.source;
                const lTargetId = typeof l.target === 'object' ? l.target.id : l.target;
                return lSourceId === sourceId && lTargetId === targetId && l.type === link.type;
            });

            detailView.innerHTML = `
                <div class="detail-header">å…³ç³»è¯¦æƒ…</div>
                <div class="detail-section">
                    <h3>å…³ç³»ç±»å‹</h3>
                    <div class="detail-content">${link.type}</div>
                </div>
                <div class="detail-section">
                    <h3>æºå®ä½“</h3>
                    <div class="detail-content" onclick="showEntityDetail(${JSON.stringify(sourceEntity)})"
                         style="cursor: pointer; text-decoration: underline;">
                        ${sourceEntity?.name || 'æœªçŸ¥å®ä½“'} (ID: ${sourceId})
                    </div>
                </div>
                <div class="detail-section">
                    <h3>ç›®æ ‡å®ä½“</h3>
                    <div class="detail-content" onclick="showEntityDetail(${JSON.stringify(targetEntity)})"
                         style="cursor: pointer; text-decoration: underline;">
                        ${targetEntity?.name || 'æœªçŸ¥å®ä½“'} (ID: ${targetId})
                    </div>
                </div>
                <div class="detail-section">
                    <h3>æ“ä½œ</h3>
                    <div class="entity-actions">
                        <div class="action-btn edit-btn" onclick="startEditRelation(${linkIndex})">
                            ç¼–è¾‘å…³ç³»
                        </div>
                        <div class="action-btn delete-btn"
                            onclick="deleteRelation('${sourceId}', '${targetId}', '${link.type}')">
                            åˆ é™¤å…³ç³»
                        </div>
                    </div>
                </div>

                <!-- å…³ç³»ç¼–è¾‘è¡¨å• -->
                <div class="relation-edit-form">
                    <h3 class="list-title">ç¼–è¾‘å…³ç³»</h3>
                    <div class="form-group">
                        <label for="edit-source-entity-display">æºå®ä½“</label>
                        <div class="entity-select-container">
                            <input type="text" id="edit-source-entity-display"
                                   value="${sourceEntity?.name || ''}"
                                   placeholder="é€‰æ‹©æˆ–æœç´¢æºå®ä½“">
                            <input type="hidden" id="edit-source-entity" value="${sourceId}">
                            <div class="entity-dropdown" id="edit-source-entity-dropdown"></div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="edit-target-entity-display">ç›®æ ‡å®ä½“</label>
                        <div class="entity-select-container">
                            <input type="text" id="edit-target-entity-display"
                                   value="${targetEntity?.name || ''}"
                                   placeholder="é€‰æ‹©æˆ–æœç´¢ç›®æ ‡å®ä½“">
                            <input type="hidden" id="edit-target-entity" value="${targetId}">
                            <div class="entity-dropdown" id="edit-target-entity-dropdown"></div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="edit-relation-type-display">å…³ç³»ç±»å‹</label>
                        <div class="relation-type-select-container">
                            <input type="text" id="edit-relation-type-display"
                                   value="${link.type}"
                                   placeholder="è¾“å…¥æˆ–é€‰æ‹©å…³ç³»ç±»å‹">

                            <input type="hidden" id="edit-relation-type" value="${link.type}">
                            <div class="relation-type-dropdown" id="edit-relation-type-dropdown"></div>
                        </div>
                    </div>
                    <div class="btn-group">
                        <button id="save-relation-edit" class="btn-primary"
                            onclick="saveRelationEdit(${linkIndex})">ä¿å­˜ä¿®æ”¹</button>
                        <button class="btn-secondary" onclick="cancelRelationEdit()">å–æ¶ˆ</button>
                    </div>
                </div>
            `;

            // åˆå§‹åŒ–ç¼–è¾‘å…³ç³»æ—¶çš„å®ä½“é€‰æ‹©ä¸‹æ‹‰æ¡†
            initEditRelationDropdowns();

            // åˆå§‹åŒ–ç¼–è¾‘å…³ç³»æ—¶çš„å…³ç³»ç±»å‹ä¸‹æ‹‰æ¡†
            initEditRelationTypeDropdown();
        }

        // åˆå§‹åŒ–ç¼–è¾‘å…³ç³»æ—¶çš„å®ä½“é€‰æ‹©ä¸‹æ‹‰æ¡†
        function initEditRelationDropdowns() {
            const editSourceDisplay = document.getElementById('edit-source-entity-display');
            const editSourceInput = document.getElementById('edit-source-entity');
            const editSourceDropdown = document.getElementById('edit-source-entity-dropdown');

            const editTargetDisplay = document.getElementById('edit-target-entity-display');
            const editTargetInput = document.getElementById('edit-target-entity');
            const editTargetDropdown = document.getElementById('edit-target-entity-dropdown');

            // æŒ‰æ·»åŠ æ—¶é—´æ’åºï¼Œæœ€è¿‘æ·»åŠ çš„åœ¨å‰é¢
            const sortedEntities = [...graphData.nodes].reverse();

            // å¡«å……æºå®ä½“ä¸‹æ‹‰æ¡†
            updateEntityDropdown(editSourceDropdown, sortedEntities);

            // å¡«å……ç›®æ ‡å®ä½“ä¸‹æ‹‰æ¡†
            updateEntityDropdown(editTargetDropdown, sortedEntities);

            // ä¸ºæºå®ä½“è¾“å…¥æ¡†æ·»åŠ äº‹ä»¶ç›‘å¬
            editSourceDisplay.addEventListener('focus', () => {
                editSourceDropdown.classList.add('visible');
            });

            editSourceDisplay.addEventListener('input', () => {
                const filtered = filterEntities(editSourceDisplay.value);
                updateEntityDropdown(editSourceDropdown, filtered);
                editSourceDropdown.classList.add('visible');
            });

            // ä¸ºæºå®ä½“ä¸‹æ‹‰æ¡†ä¸­çš„é€‰é¡¹æ·»åŠ ç‚¹å‡»äº‹ä»¶
            editSourceDropdown.querySelectorAll('.dropdown-item').forEach(item => {
                item.addEventListener('click', () => {
                    editSourceInput.value = item.dataset.id;
                    editSourceDisplay.value = item.dataset.name;
                    editSourceDropdown.classList.remove('visible');
                });
            });

            // ä¸ºç›®æ ‡å®ä½“è¾“å…¥æ¡†æ·»åŠ äº‹ä»¶ç›‘å¬
            editTargetDisplay.addEventListener('focus', () => {
                editTargetDropdown.classList.add('visible');
            });

            editTargetDisplay.addEventListener('input', () => {
                const filtered = filterEntities(editTargetDisplay.value);
                updateEntityDropdown(editTargetDropdown, filtered);
                editTargetDropdown.classList.add('visible');
            });

            // ä¸ºç›®æ ‡å®ä½“ä¸‹æ‹‰æ¡†ä¸­çš„é€‰é¡¹æ·»åŠ ç‚¹å‡»äº‹ä»¶
            editTargetDropdown.querySelectorAll('.dropdown-item').forEach(item => {
                item.addEventListener('click', () => {
                    editTargetInput.value = item.dataset.id;
                    editTargetDisplay.value = item.dataset.name;
                    editTargetDropdown.classList.remove('visible');
                });
            });
        }

        // åˆå§‹åŒ–ç¼–è¾‘å…³ç³»æ—¶çš„å…³ç³»ç±»å‹ä¸‹æ‹‰æ¡†
        function initEditRelationTypeDropdown() {
            const editRelationTypeDisplay = document.getElementById('edit-relation-type-display');
            const editRelationTypeInput = document.getElementById('edit-relation-type');
            const editRelationTypeDropdown = document.getElementById('edit-relation-type-dropdown');

            // å¡«å……å…³ç³»ç±»å‹ä¸‹æ‹‰æ¡†
            updateRelationTypeDropdownForEdit(editRelationTypeDropdown);

            // ä¸ºå…³ç³»ç±»å‹è¾“å…¥æ¡†æ·»åŠ äº‹ä»¶ç›‘å¬
            editRelationTypeDisplay.addEventListener('focus', () => {
                editRelationTypeDropdown.classList.add('visible');
            });

            editRelationTypeDisplay.addEventListener('input', () => {
                const filtered = filterRelationTypes(editRelationTypeDisplay.value);
                updateRelationTypeDropdownForEdit(editRelationTypeDropdown, filtered);
                editRelationTypeDropdown.classList.add('visible');
            });

            // ä¸ºå…³ç³»ç±»å‹ä¸‹æ‹‰æ¡†ä¸­çš„é€‰é¡¹æ·»åŠ ç‚¹å‡»äº‹ä»¶
            editRelationTypeDropdown.querySelectorAll('.dropdown-item').forEach(item => {
                item.addEventListener('click', () => {
                    editRelationTypeInput.value = item.dataset.type;
                    editRelationTypeDisplay.value = item.dataset.type;
                    editRelationTypeDropdown.classList.remove('visible');
                });
            });
        }

        // æ›´æ–°ç¼–è¾‘å…³ç³»æ—¶çš„å…³ç³»ç±»å‹ä¸‹æ‹‰æ¡†
        function updateRelationTypeDropdownForEdit(dropdownElement, types) {
            dropdownElement.innerHTML = '';

            const relationTypes = types || Array.from(usedRelationTypes).sort();

            if (relationTypes.length === 0) {
                const emptyItem = document.createElement('div');
                emptyItem.className = 'dropdown-item';
                emptyItem.textContent = 'æš‚æ— å…³ç³»ç±»å‹';
                emptyItem.style.cursor = 'default';
                emptyItem.style.opacity = '0.7';
                dropdownElement.appendChild(emptyItem);
                return;
            }

            relationTypes.forEach(type => {
                const item = document.createElement('div');
                item.className = 'dropdown-item';
                item.textContent = type;
                item.dataset.type = type;

                dropdownElement.appendChild(item);
            });
        }

        // ä¿å­˜å…³ç³»ç¼–è¾‘
        function saveRelationEdit(linkIndex) {
            if (linkIndex < 0 || linkIndex >= graphData.links.length) return;

            const sourceId = document.getElementById('edit-source-entity').value;
            const targetId = document.getElementById('edit-target-entity').value;
            const type = document.getElementById('edit-relation-type').value.trim();

            if (!sourceId || !targetId || !type) {
                alert('è¯·å®Œå–„å…³ç³»ä¿¡æ¯');
                return;
            }

            if (sourceId === targetId) {
                alert('æºå®ä½“å’Œç›®æ ‡å®ä½“ä¸èƒ½ç›¸åŒ');
                return;
            }

            // æ£€æŸ¥æ›´æ–°åçš„å…³ç³»æ˜¯å¦å·²å­˜åœ¨ï¼ˆæ’é™¤è‡ªèº«ï¼‰
            const relationExists = graphData.links.some((link, index) => {
                if (index === linkIndex) return false;

                const lSourceId = typeof link.source === 'object' ? link.source.id : link.source;
                const lTargetId = typeof link.target === 'object' ? link.target.id : link.target;
                return lSourceId === sourceId && lTargetId === targetId && link.type === type;
            });

            if (relationExists) {
                alert('æ­¤å…³ç³»å·²å­˜åœ¨');
                return;
            }

            // è®°å½•æ—§çš„å…³ç³»ç±»å‹ï¼Œç”¨äºæ›´æ–°å…³ç³»ç±»å‹é›†åˆ
            const oldType = graphData.links[linkIndex].type;

            // æ›´æ–°å…³ç³»æ•°æ®
            graphData.links[linkIndex] = {
                source: sourceId,
                target: targetId,
                type: type
            };

            // æ›´æ–°å·²ä½¿ç”¨çš„å…³ç³»ç±»å‹
            updateUsedRelationTypes();
            updateRelationTypeDropdown();

            // åˆ·æ–°ç•Œé¢
            reloadGraph();
            alert('å…³ç³»æ›´æ–°æˆåŠŸ');

            // é‡æ–°æ˜¾ç¤ºæ›´æ–°åçš„å…³ç³»è¯¦æƒ…
            showRelationDetail(graphData.links[linkIndex]);
        }

        // å–æ¶ˆå…³ç³»ç¼–è¾‘
        function cancelRelationEdit() {
            if (selectedLink) {
                showRelationDetail(selectedLink);
            } else {
                detailView.innerHTML = '<div class="no-data">é€‰æ‹©ä¸€ä¸ªå®ä½“æˆ–å…³ç³»æŸ¥çœ‹è¯¦æƒ…</div>';
            }
        }

        // é‡ç½®æœç´¢çŠ¶æ€
        function resetSearchState() {
            searchResults = [];
            currentResultIndex = -1;
            lastSearchKeyword = '';
            lastSearchType = searchTypeSelect.value;
            searchResultsInfo.textContent = '';
        }

        // ------------------------------
        // æœç´¢ä¸è½®è¯¢æ˜¾ç¤ºåŠŸèƒ½ - æŒ‰ç±»å‹æœç´¢
        // ------------------------------
        function searchAndLocate() {
            const keyword = searchInput.value.trim().toLowerCase();
            const searchType = searchTypeSelect.value;

            if (!keyword) {
                resetSearchState();
                return;
            }

            const isNewSearch = keyword !== lastSearchKeyword || searchType !== lastSearchType;

            if (isNewSearch) {
                lastSearchKeyword = keyword;
                lastSearchType = searchType;
                searchResults = [];

                // æ ¹æ®é€‰æ‹©çš„æœç´¢ç±»å‹è¿›è¡Œæœç´¢
                switch(searchType) {
                    case 'entityId':
                        // æŒ‰å®ä½“IDæœç´¢ï¼ˆç²¾ç¡®åŒ¹é…ï¼‰
                        const idMatch = graphData.nodes.find(node => node.id === keyword);
                        if (idMatch) {
                            searchResults.push({
                                type: 'entity',
                                data: idMatch
                            });
                        }
                        break;

                    case 'entityName':
                        // æŒ‰å®ä½“åç§°æœç´¢ï¼ˆæ¨¡ç³ŠåŒ¹é…ï¼‰
                        graphData.nodes.forEach(node => {
                            if (node.name.toLowerCase().includes(keyword)) {
                                searchResults.push({
                                    type: 'entity',
                                    data: node
                                });
                            }
                        });
                        break;

                    case 'entityDesc':
                        // æŒ‰å®ä½“æè¿°æœç´¢ï¼ˆæ¨¡ç³ŠåŒ¹é…ï¼‰
                        graphData.nodes.forEach(node => {
                            if (node.description && node.description.toLowerCase().includes(keyword)) {
                                searchResults.push({
                                    type: 'entity',
                                    data: node
                                });
                            }
                        });
                        break;

                    case 'relation':
                        // æŒ‰å…³ç³»ç±»å‹æœç´¢ï¼ˆæ¨¡ç³ŠåŒ¹é…ï¼‰
                        graphData.links.forEach(link => {
                            if (link.type.toLowerCase().includes(keyword)) {
                                searchResults.push({
                                    type: 'relation',
                                    data: link
                                });
                            }
                        });
                        break;
                }

                currentResultIndex = 0;
            } else {
                if (searchResults.length > 0) {
                    currentResultIndex = (currentResultIndex + 1) % searchResults.length;
                }
            }

            if (searchResults.length === 0) {
                const searchTypeName = document.querySelector(`#search-type option[value="${searchType}"]`).text;
                searchResultsInfo.textContent = `æœªæ‰¾åˆ°åŒ¹é…"${searchTypeName}"çš„ç»“æœ`;
                detailView.innerHTML = `<div class="no-data">æœªæ‰¾åˆ°åŒ¹é…"${searchTypeName}"çš„å®ä½“æˆ–å…³ç³»</div>`;
                clearAllHighlights();
                return;
            }

            const searchTypeName = document.querySelector(`#search-type option[value="${searchType}"]`).text;
            searchResultsInfo.textContent = `æ‰¾åˆ° ${searchResults.length} ä¸ªåŒ¹é…"${searchTypeName}"çš„ç»“æœï¼Œæ˜¾ç¤ºç¬¬ ${currentResultIndex + 1} ä¸ª`;

            const currentResult = searchResults[currentResultIndex];
            if (currentResult.type === 'entity') {
                const entity = currentResult.data;
                showEntityDetail(entity);
                centerNodeInView(entity.id);
                highlightSearchEntity(entity.id);
            } else if (currentResult.type === 'relation') {
                const link = currentResult.data;
                showRelationDetail(link);
                centerRelationInView(link);
                highlightSearchRelation(link);
            }
        }

        // ------------------------------
        // äº‹ä»¶ç›‘å¬ç»‘å®š
        // ------------------------------
        function setupEventListeners() {
            setupFileEventListeners();

            addEntityBtn.addEventListener('click', addEntity);
            updateEntityBtn.addEventListener('click', updateEntity);
            cancelEditBtn.addEventListener('click', cancelEdit);
            clearEntityFormBtn.addEventListener('click', () => {
                clearEntityForm();
                // é‡æ–°å¡«å……é»˜è®¤å€¼
                populateDefaultEntityValues();
            });

            addRelationBtn.addEventListener('click', addRelation);
            clearRelationFormBtn.addEventListener('click', clearRelationForm);

            searchBtn.addEventListener('click', searchAndLocate);
            searchInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') searchAndLocate();
            });

            zoomInBtn.addEventListener('click', zoomIn);
            zoomOutBtn.addEventListener('click', zoomOut);
            fitViewBtn.addEventListener('click', fitView);
            resetViewBtn.addEventListener('click', resetLayout);

            // æºå®ä½“é€‰æ‹©æ¡†äº‹ä»¶
            sourceEntityDisplay.addEventListener('focus', () => {
                sourceEntityDropdown.classList.add('visible');
                sourceEntityDropdown.classList.add('visible');
            });

            sourceEntityDisplay.addEventListener('input', () => {
                const filtered = filterEntities(sourceEntityDisplay.value);
                updateEntityDropdown(sourceEntityDropdown, filtered);
                sourceEntityDropdown.classList.add('visible');
            });

            // ç›®æ ‡å®ä½“é€‰æ‹©æ¡†äº‹ä»¶
            targetEntityDisplay.addEventListener('focus', () => {
                targetEntityDropdown.classList.add('visible');
            });

            targetEntityDisplay.addEventListener('input', () => {
                const filtered = filterEntities(targetEntityDisplay.value);
                updateEntityDropdown(targetEntityDropdown, filtered);
                targetEntityDropdown.classList.add('visible');
            });

            // å…³ç³»ç±»å‹é€‰æ‹©æ¡†äº‹ä»¶
            relationTypeDisplay.addEventListener('focus', () => {
                relationTypeDropdown.classList.add('visible');
            });

            relationTypeDisplay.addEventListener('input', () => {
                const filtered = filterRelationTypes(relationTypeDisplay.value);
                // æ›´æ–°å…³ç³»ç±»å‹ä¸‹æ‹‰æ¡†
                relationTypeDropdown.innerHTML = '';
                if (filtered.length === 0) {
                    const emptyItem = document.createElement('div');
                    emptyItem.className = 'dropdown-item';
                    emptyItem.textContent = 'æ— åŒ¹é…çš„å…³ç³»ç±»å‹';
                    emptyItem.style.cursor = 'default';
                    emptyItem.style.opacity = '0.7';
                    relationTypeDropdown.appendChild(emptyItem);
                } else {
                    filtered.forEach(type => {
                        const item = document.createElement('div');
                        item.className = 'dropdown-item';
                        item.textContent = type;
                        item.dataset.type = type;

                        item.addEventListener('click', () => {
                            relationTypeInput.value = type;
                            relationTypeDisplay.value = type;
                            relationTypeDropdown.classList.remove('visible');
                        });

                        relationTypeDropdown.appendChild(item);
                    });
                }
                relationTypeDropdown.classList.add('visible');
            });

            // ç‚¹å‡»å…¶ä»–åŒºåŸŸå…³é—­ä¸‹æ‹‰æ¡†
            document.addEventListener('click', (event) => {
                if (!event.target.closest('.entity-select-container') &&
                    !event.target.closest('.relation-type-select-container')) {
                    sourceEntityDropdown.classList.remove('visible');
                    targetEntityDropdown.classList.remove('visible');
                    relationTypeDropdown.classList.remove('visible');

                    // å…³é—­ç¼–è¾‘å…³ç³»æ—¶çš„ä¸‹æ‹‰æ¡†
                    const editSourceDropdown = document.getElementById('edit-source-entity-dropdown');
                    const editTargetDropdown = document.getElementById('edit-target-entity-dropdown');
                    const editRelationTypeDropdown = document.getElementById('edit-relation-type-dropdown');

                    if (editSourceDropdown) editSourceDropdown.classList.remove('visible');
                    if (editTargetDropdown) editTargetDropdown.classList.remove('visible');
                    if (editRelationTypeDropdown) editRelationTypeDropdown.classList.remove('visible');
                }
            });

            // çª—å£å¤§å°å˜åŒ–æ—¶é‡ç»˜å›¾è°±
            window.addEventListener('resize', () => {
                if (graphData.nodes.length > 0) {
                    reloadGraph();
                    fitView();
                }
            });
        }

        // å…¨å±€å‡½æ•°ï¼Œç”¨äºå…³ç³»ç¼–è¾‘æ“ä½œ
        window.startEditRelation = startEditRelation;
        window.deleteRelation = deleteRelation;
        window.startEditEntity = startEditEntity;
        window.deleteEntity = deleteEntity;
        window.showEntityDetail = showEntityDetail;
        window.saveRelationEdit = saveRelationEdit;
        window.cancelRelationEdit = cancelRelationEdit;
    </script>
</body>
</html>
